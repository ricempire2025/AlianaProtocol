# 多层次资金健康自动调节系统（基于 `alianaProtocol` 合约）

> 目标：在不改变协议核心业务体验的前提下，通过“可观测指标 + 多层防线 + 参数闭环调节”，尽量维持合约 USDT 偿付能力、降低挤兑风险，并为治理/运维提供可审计的动作轨迹。  
> 参考实现入口：`makeDeposit`（入金）、`claimDailyRewards` / `claimNetworkRewards`（出金）、`compoundDailyRewards` / `compoundNetworkRewards`（复投与费用）等函数。

---

## 1. 现有合约的资金口径（你目前链上实际发生的流入/流出）

**资金流入**
- 仅来自 `makeDeposit` 的 `USDT_TOKEN.transferFrom(user, contract, amount)`（`contracts/AlianaProtocol.sol:219`）。

**资金流出**
- 管理费：`makeDeposit`、`compoundDailyRewards`、`compoundNetworkRewards` 都会把 `amount * 5%` 转到 `TREASURY_WALLET`（`contracts/AlianaProtocol.sol:221-223`, `325-327`, `413-415`）。
- 用户提现：
  - 日收益提现：`claimDailyRewards` 向用户转 USDT（`contracts/AlianaProtocol.sol:285`）。
  - 网络收益提现：`claimNetworkRewards` 向用户转 USDT（`contracts/AlianaProtocol.sol:376`）。

**关键事实（直接影响“资金健康系统”的可定义负债）**
- 合约没有“本金赎回”接口；用户可提现的是收益（Daily/Network）。仓位到期只是 `activeInvestments` 与团队业绩回退（`_calculateAndUpdatePendingRewards` 里 `position.isActive=false`），不是本金返还（`contracts/AlianaProtocol.sol:953-963`）。

**因此建议的“偿付口径”**
- 主要偿付压力 = “当前可立即提现的收益（含 reserve）” + “短期内将累积到可提现的收益（未来 \(N\) 天）”。

---

## 2. 系统总体架构：监控层 + 决策层 + 执行层

- **监控层（Metrics）**：定义资金健康指标、采集链上数据、生成健康分层（Green/Yellow/Orange/Red）。
- **决策层（Policy Engine）**：将指标映射为“可执行动作”（调参、限流、熔断、激励等）。
- **执行层（Actuators）**：将动作落地到链上（参数更新 / 限制提现 / 调整费率 / 调整收益 / 启动应急模式）。

落地方式两种（可并行准备）：
- **Hybrid（推荐）**：链上执行 + 链下 Keeper 监控触发（动作可由 Timelock+多签确认）。
- **Fully On-chain**：所有指标与决策都在链上自动执行（难点是计算成本与可被操纵风险）。

---

## 3. 资金健康指标体系（建议至少三类：偿付、流动性、增长）

### 3.1 偿付类（Solvency）
- `USDT_BAL`：合约 USDT 余额（IERC20 `balanceOf(address(this))`）。
- `CLAIMABLE_NOW`：理论“可立即提现”的总额（需要全局累计口径，否则逐用户遍历会很贵）。
- `HF0（当前偿付率）= USDT_BAL / CLAIMABLE_NOW`  
  - `HF0 >= 1.2`：Green  
  - `1.0 <= HF0 < 1.2`：Yellow  
  - `0.8 <= HF0 < 1.0`：Orange  
  - `< 0.8`：Red

> 说明：你现在合约只有 `getDailyRewardsBalance(user)` / `getNetworkRewardsBalance(user)`（`contracts/AlianaProtocol.sol:435-447`），缺少“全局可提现总额”的累计变量。要做自动调节，强烈建议后续版本增加 `globalClaimable`/`globalReserves` 之类的聚合指标。

### 3.2 流动性类（Liquidity / Bank-run early warning）
- `NET_FLOW_24H`：24 小时净流入 = deposits - withdrawals（可由事件索引 `DepositMade`、`DailyRewardsClaimed`、`NetworkRewardsClaimed` 统计）。
- `WITHDRAW_RATIO_1H`：近 1 小时提现/余额比，作为挤兑报警。
- `QUEUE_PRESSURE`：提现请求数量/金额（如果未来引入“提现队列”机制可直接链上统计）。

### 3.3 增长与结构类（Growth / Structure）
- `ACTIVE_INVEST`：全网活跃仓位总额（当前合约没有全局聚合，只能估算；建议后续版本维护）。
- `EMISSION_RATE`：单位时间“收益铸造速度”（你现在是按时间线性累积：`positionReward = principal * dailyPercent * timeElapsed / ...`，`contracts/AlianaProtocol.sol:946-948`）。
- `FEE_LEAK`：手续费外流速率（因为 5% 直接出合约到 `TREASURY_WALLET`）。

---

## 4. 多层次防线设计（四级，逐级加严，避免“一刀切”）

### Level 0：可观测 + 透明披露（不改协议行为）
**触发条件**
- HF0 下降趋势、净流入转负、提现比率异常等。

**动作**
- 仅输出看板/告警：链上事件 + 前端提示 + 风险面板。
- 不引入任何权限动作，确保用户体验稳定。

### Level 1：软约束（Soft Throttle，不改变收益规则，只控制节奏）
**触发条件**
- Yellow/Orange 阶段：例如 `HF0 < 1.2` 或 `WITHDRAW_RATIO_1H` 超阈值。

**动作建议**
- **提现速率限制**：对 `claimDailyRewards` / `claimNetworkRewards` 引入“每地址每日最大提现额”、“每小时全局最大提现额”、“冷却时间”等。
- **提现分段**：高风险期强制 `amount` 上限，避免大额瞬时抽干余额。
- **引导复投激励**：在风险期对 `compound*` 提供额外权重（比如降低复投手续费或给复投加成，但要有上限）。

实现提示（后续版本）：
- 增加 `withdrawCapPerDay`, `globalWithdrawCapPerHour`, `lastWithdrawAt[user]` 等状态变量。
- 在 `claimDailyRewards` / `claimNetworkRewards` 的 `require` 前置检查中执行。

### Level 2：动态调参（Parameter Control，改变资金留存/发放强度）
**触发条件**
- Orange/Red：`HF0 < 1.0` 或净流出持续。

**可调参数建议（都需要“上下限”和“渐变速率限制”）**
- **动态手续费**：将 `ADMIN_FEE_PERCENT` 从常量改为可调区间（例如 3%–15%）。  
  - 资金健康差 → 提高手续费并将一部分沉淀到“Reserve Vault”，而不是全给 `TREASURY_WALLET`。
- **动态最小提现**：提高 `MIN_WITHDRAW_AMOUNT`（只能临时提高，且需公告与上限），减少链上碎片提现频率与 gas 成本，但会影响小额用户体验，谨慎使用。

### Level 3：应急模式（Circuit Breaker）
**触发条件**
- `HF0` 极低（例如 `< 0.8`）或检测到异常（合约余额不足以覆盖最小提现等）。

**动作**
- 暂停提现（仅暂停 `claim*`，不暂停 `compound*` 或 `makeDeposit` 需谨慎）。
- 开启“提现队列 + 分批释放”：按日/小时释放固定流动性，保证公平。
- 允许 `TREASURY_WALLET` / Reserve 向合约注资（如果你愿意提供背书），并把注资与偿付进度透明化。

---

## 5. 执行机制与治理安全（防止“调参即 rug”）

因为你当前合约关键参数是 `constant`，且没有管理函数，想要“自动调节”需要下一版合约（或代理可升级）。

**建议治理模型（从安全到体验的平衡）**
- **Timelock + 多签**：所有 Level2/Level3 动作必须延时执行（如 6–24 小时），并上链公告（事件）。
- **动作白名单 + 参数边界**：例如：
  - `ADMIN_FEE_PERCENT` 在 [300, 1500] bps；
  - `MIN_WITHDRAW_AMOUNT` 在合理区间内临时上调，且有最高上限；
  - 全局/单地址限流阈值只能在预设边界内调整。
- **紧急权力隔离**：紧急暂停可以更快，但“解除暂停/恢复收益”必须走更严格流程。
- **紧急权力隔离**：紧急暂停可以更快，但“解除暂停/恢复正常”必须走更严格流程。
- **可审计事件**：每次调参必须 emit `HealthPolicyUpdated(...)` / `EmergencyModeChanged(...)`，方便前端与索引器展示。

---

## 6. 指标到动作的策略表（示例）

| 健康状态 | 条件（示例） | 动作集合 |
|---|---|---|
| Green | HF0 ≥ 1.2 | 不干预，仅披露 |
| Yellow | 1.0 ≤ HF0 < 1.2 | Level1：单地址提现上限 + 冷却；提示复投 |
| Orange | 0.8 ≤ HF0 < 1.0 | Level1 强化 + Level2：提高留存费率；提高最小提现；加强全局限流 |
| Red | HF0 < 0.8 | Level3：暂停提现或队列；引入注资/债务重整机制 |

---

## 7. 与你当前合约的“最小改造路径”（建议你后续迭代按此落地）

你目前关键难点是：**没有全局聚合负债指标**，而收益是按用户仓位逐个累积计算（`_calculatePendingRewards` / `_calculateAndUpdatePendingRewards`）。要做“自动健康调节”，建议下一版至少加入：

- `globalDailyReserves`、`globalNetworkReserves`：与用户侧 reserve 同步增减。
- `globalAccruedRewards` / `globalClaimableEstimate`：在每次用户触发结算时更新聚合值（不要求精确到每秒，但要可用于 HF0 评估）。
- `healthMode`（0/1/2/3）与对应参数组（费率、收益倍率、提现上限等）。
- `keeperTrigger()`：允许 keeper 提交最新状态并触发 mode 切换（带阈值、延时、可回滚保护）。

---

## 8. 风险提示（必须写进产品与前端）

- 动态调参会改变用户预期，必须：
  - 明确“哪些参数可能变动、变动边界、变动频率、公告方式”；
  - 前端在用户存入前展示当前 `healthMode` 与关键参数；
  - 所有调参事件可追溯、可验证。
- 若采用链下 keeper：需要防止“单点作恶”，必须走多签或至少可被否决的 timelock。

---

## 9. 建议你下一步如果要我继续（可选）
- 我可以基于你现有合约结构，给出一版“可升级/可调参”的合约架构草图（模块：`HealthController`、`ReserveVault`、`WithdrawLimiter`），并把每个参数如何挂到 `claimDailyRewards` / `claimNetworkRewards` 的校验点写清楚（同时保证 gas 可控）。

---

## 10. 链上模块拆分（建议的最小可落地架构）

> 目标：把“业务合约（收益/推荐逻辑）”与“健康调节（限流/调参/应急）”解耦，既可升级迭代，也更容易审计。

### 10.1 方案 A（推荐）：主协议 + 外置控制器

- `AlianaProtocol`（主协议）
  - 保持你当前的业务结构：注册、入金、收益计算、提现/复投。
  - 在 `makeDeposit`、`claimDailyRewards`、`claimNetworkRewards`、`compound*` 的关键点增加 hook：`healthController.beforeDeposit/beforeClaim/...`。
- `HealthController`（健康控制器）
  - 维护 `healthMode`、可调参数、提现限流、队列开关。
  - 提供给主协议的校验接口：返回本次操作允许的最大额度、是否需要排队、当前费率/收益倍率。
- `ReserveVault`（准备金/缓冲池，可选但强烈建议）
  - 将“部分手续费”或“部分收益留存”沉淀为可用于应急偿付的资金池。
  - 需要明确资金所有权：属于协议公共准备金还是属于 treasury。

### 10.2 方案 B：主协议内置健康模块（改动更少，但耦合更强）

- 直接在主协议里新增：`healthMode`、`withdrawLimiter`、`params`。
- 优点：部署少、调用少。
- 缺点：后续升级难、审计面更复杂。

---

## 11. 状态机与调节动作（Mode + Action）

### 11.1 Health Mode（建议 5 档而不是 4 档）

| Mode | 名称 | 目标 | 主要动作 |
|---|---|---|---|
| 0 | Normal | 正常运行 | 不限流、参数基准 |
| 1 | Watch | 早期预警 | 只提示、只统计 |
| 2 | Throttle | 抗挤兑 | 限制提现速率/单笔上限 |
| 3 | Stabilize | 稳态保护 | 提高手续费留存/提高最小提现/强化全局限流 |
| 4 | Emergency | 保命模式 | 暂停提现或队列分批释放 |

建议触发：用 `HF0` 做主触发，用 `NET_FLOW_24H` 与 `WITHDRAW_RATIO_1H` 做副触发；从高风险回到低风险必须更严格（滞回 hysteresis），避免模式来回抖动。

### 11.2 Action 集合（对应你合约的入口函数）

- `makeDeposit`：不建议在风险期禁止入金；更常用的是调整“入金手续费沉淀比例”。
- `claimDailyRewards` / `claimNetworkRewards`：主要限流点（单地址/全局/队列）。
- `compoundDailyRewards` / `compoundNetworkRewards`：主要激励点（风险期允许更顺畅、甚至降低复投费率）。

---

## 12. 可调参数设计（带边界、带速率限制）

> 原则：参数可调 ≠ 任意可调。必须明确“上下限”和“单位时间最大变化量”。

### 12.1 推荐的参数分组

**提现控制**
- `maxClaimPerTxDaily`：单次 `claimDailyRewards` 最大值
- `maxClaimPerDayDaily[userTier]`：单地址每日最大值（可按投资档位分层）
- `maxClaimGlobalPerHourDaily`：全局每小时最大值
- `cooldownSecondsDaily`：两次提现冷却

**网络收益控制**
- `maxClaimPerTxNetwork`
- `maxClaimGlobalPerHourNetwork`
- `cooldownSecondsNetwork`

**费率与留存**
- `adminFeeBps`：原 `ADMIN_FEE_PERCENT`
- `feeToReserveBps`：手续费中进入 `ReserveVault` 的比例
- `reserveReleaseBps`：准备金在应急队列中释放的比例/速率

### 12.2 边界与速率限制（示例）

- `adminFeeBps` ∈ [300, 1500]，每 24h 变化不超过 100 bps
- `feeToReserveBps` ∈ [0, 2000]（0%~20%），每 24h 变化不超过 200 bps
- `MIN_WITHDRAW_AMOUNT` 只能临时上调且有硬顶，调整频率受 timelock 约束

---

## 13. Keeper/预言机与可操纵性（如何避免被刷指标触发）

### 13.1 指标数据来源

- `USDT_BAL`：链上可直接取（不可操纵，但会被闪电转账影响瞬时值）。
- `WITHDRAW_RATIO_1H`、`NET_FLOW_24H`：事件统计（可被“自买自卖”式刷流水影响）。

### 13.2 抗操纵策略

- 使用“窗口平均 + 最小持续时间”触发：例如连续 6 个 10 分钟窗口都满足阈值才升级 mode。
- 升级 mode 可快，降级 mode 必须慢（例如至少 24h 并持续满足回撤条件）。
- 对极端值做裁剪：`HF0` 只采样每个 checkpoint（你合约有 day checkpoint 概念）。
- Keeper 只负责提交观测值，不直接改参数；改参数走 timelock。

---

## 14. 事件与看板（让用户可验证、让运营可回溯）

### 14.1 必要事件（建议新增）

- `HealthModeChanged(uint8 oldMode, uint8 newMode, uint256 timestamp)`
- `HealthParamsUpdated(bytes32 key, uint256 oldValue, uint256 newValue, uint256 timestamp)`
- `WithdrawThrottled(address user, uint8 stream, uint256 requested, uint256 allowed, uint256 timestamp)`
- `WithdrawQueued(address user, uint8 stream, uint256 amount, uint256 eta, uint256 timestamp)`
- `ReserveFunded(uint256 amount, uint256 timestamp)`
- `ReserveReleased(uint256 amount, uint256 timestamp)`

### 14.2 看板指标（最小集合）

- 合约 USDT 余额（实时）
- 近 1h / 24h 入金与出金
- 当前 `healthMode` 与关键参数（限流上限、倍率、费率）
- 预计未来 7 天的收益负债增速（用当前日化与活跃金额估算）

---

## 15. 实施路线图（按风险从低到高逐步上线）

### Phase 1：只监控不干预（可立刻上线）
- 子图/索引：抓取 `DepositMade`、`DailyRewardsClaimed`、`NetworkRewardsClaimed`、`DailyRewardsCompounded`、`NetworkRewardsCompounded`
- 前端增加风险面板与公告区

### Phase 2：软限流（对业务影响最小）
- 引入 `WithdrawLimiter`：冷却、单笔上限、单日上限
- 只对提现入口生效，不改变收益计算

### Phase 3：参数闭环调节（需要治理与边界）
- 引入动态费率与留存规则
- 引入 `ReserveVault` 并定义资金归属

### Phase 4：应急队列与分批释放
- 启用 `Emergency` 模式时：提现转入队列
- 准备金与合约余额按规则释放

---


